name: Build PHP for Android

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      php_version:
        description: 'PHP version to build'
        required: true
        default: '8.3.0'

env:
  ANDROID_NDK_VERSION: 'r26b'
  ANDROID_API: 21
  PHP_VERSION: ${{ github.event.inputs.php_version || '8.3.0' }}

jobs:
  build:
    runs-on: ubuntu-22.04
    
    strategy:
      matrix:
        arch: [arm64, arm, x86_64, x86]
        include:
          - arch: arm64
            target: aarch64-linux-android
            clang_prefix: aarch64-linux-android
            android_abi: arm64-v8a
            openssl_config: linux-aarch64
          - arch: arm
            target: armv7a-linux-androideabi
            clang_prefix: armv7a-linux-androideabi
            android_abi: armeabi-v7a
            openssl_config: linux-armv4
          - arch: x86_64
            target: x86_64-linux-android
            clang_prefix: x86_64-linux-android
            android_abi: x86_64
            openssl_config: linux-x86_64
          - arch: x86
            target: i686-linux-android
            clang_prefix: i686-linux-android
            android_abi: x86
            openssl_config: linux-x86
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Android NDK
      run: |
        mkdir -p /tmp/android-ndk
        cd /tmp/android-ndk
        wget -q https://dl.google.com/android/repository/android-ndk-${{ env.ANDROID_NDK_VERSION }}-linux.zip
        unzip -q android-ndk-${{ env.ANDROID_NDK_VERSION }}-linux.zip
        echo "NDK_PATH=/tmp/android-ndk/android-ndk-${{ env.ANDROID_NDK_VERSION }}" >> $GITHUB_ENV
        echo "$(pwd)/android-ndk-${{ env.ANDROID_NDK_VERSION }}/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          autoconf \
          automake \
          libtool \
          pkg-config \
          bison \
          re2c \
          libxml2-dev \
          libssl-dev \
          libcurl4-openssl-dev \
          libsqlite3-dev \
          libonig-dev \
          libzip-dev \
          zlib1g-dev \
          libpng-dev \
          libjpeg-dev \
          libwebp-dev \
          libfreetype6-dev \
          libgmp-dev \
          libedit-dev \
          libxslt1-dev \
          xz-utils \
          bzip2 \
          unzip \
          cmake \
          ninja-build \
          wget \
          curl \
          ca-certificates \
          libicu-dev \
          libbz2-dev \
          liblz4-dev \
          liblzma-dev \
          perl \
          python3 \
          libtool-bin
    
    - name: Download PHP source
      run: |
        wget -q https://www.php.net/distributions/php-${{ env.PHP_VERSION }}.tar.gz
        tar -xzf php-${{ env.PHP_VERSION }}.tar.gz
        echo "PHP_SOURCE_DIR=$(pwd)/php-${{ env.PHP_VERSION }}" >> $GITHUB_ENV
    
    - name: Setup cross-compilation environment
      run: |
        export TOOLCHAIN="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64"
        export AR="$TOOLCHAIN/bin/llvm-ar"
        
        # 修复：使用正确的编译器命名
        # 在 NDK r26b 中，编译器命名可能是 aarch64-linux-android21-clang
        # 而不是 aarch64-none-linux-android21-clang
        export CC="$TOOLCHAIN/bin/${{ matrix.clang_prefix }}${ANDROID_API}-clang"
        export CXX="$TOOLCHAIN/bin/${{ matrix.clang_prefix }}${ANDROID_API}-clang++"
        
        # 检查编译器是否存在
        echo "检查编译器: $CC"
        if [ ! -f "$CC" ]; then
            echo "警告: 编译器 $CC 不存在，尝试备用命名"
            # 尝试备用命名
            export CC="$TOOLCHAIN/bin/${{ matrix.clang_prefix }}-clang"
            export CXX="$TOOLCHAIN/bin/${{ matrix.clang_prefix }}-clang++"
            echo "备用编译器: $CC"
        fi
        
        export LD="$TOOLCHAIN/bin/ld"
        export RANLIB="$TOOLCHAIN/bin/llvm-ranlib"
        export STRIP="$TOOLCHAIN/bin/llvm-strip"
        
        export CFLAGS="-Os -fPIE -fPIC -D__ANDROID_API__=${{ env.ANDROID_API }}"
        export LDFLAGS="-pie"
        
        echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV
        echo "TARGET=${{ matrix.target }}" >> $GITHUB_ENV
        echo "CLANG_PREFIX=${{ matrix.clang_prefix }}" >> $GITHUB_ENV
        echo "SYSROOT=$TOOLCHAIN/sysroot" >> $GITHUB_ENV
        echo "CFLAGS=$CFLAGS" >> $GITHUB_ENV
        echo "LDFLAGS=$LDFLAGS" >> $GITHUB_ENV
        echo "AR=$AR" >> $GITHUB_ENV
        echo "CC=$CC" >> $GITHUB_ENV
        echo "CXX=$CXX" >> $GITHUB_ENV
        echo "LD=$LD" >> $GITHUB_ENV
        echo "RANLIB=$RANLIB" >> $GITHUB_ENV
        echo "STRIP=$STRIP" >> $GITHUB_ENV
        echo "ANDROID_ABI=${{ matrix.android_abi }}" >> $GITHUB_ENV
        echo "OPENSSL_CONFIG=${{ matrix.openssl_config }}" >> $GITHUB_ENV
    
    - name: Build dependencies (static libraries)
      run: |
        set -e
        echo "开始构建依赖库..."
        
        # 创建目录
        DEPS_DIR="$PWD/build_deps"
        mkdir -p "$DEPS_DIR"
        cd "$DEPS_DIR"
        
        # 设置环境变量
        export TOOLCHAIN="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64"
        export AR="$TOOLCHAIN/bin/llvm-ar"
        export CC="$TOOLCHAIN/bin/${CLANG_PREFIX}${ANDROID_API}-clang"
        export CXX="$TOOLCHAIN/bin/${CLANG_PREFIX}${ANDROID_API}-clang++"
        
        # 检查编译器是否存在
        if [ ! -f "$CC" ]; then
            echo "编译器 $CC 不存在，尝试备用命名"
            export CC="$TOOLCHAIN/bin/${CLANG_PREFIX}-clang"
            export CXX="$TOOLCHAIN/bin/${CLANG_PREFIX}-clang++"
        fi
        
        export LD="$TOOLCHAIN/bin/ld"
        export RANLIB="$TOOLCHAIN/bin/llvm-ranlib"
        export STRIP="$TOOLCHAIN/bin/llvm-strip"
        export SYSROOT="$TOOLCHAIN/sysroot"
        export PATH="$TOOLCHAIN/bin:$PATH"
        
        # 验证编译器
        echo "验证编译器..."
        echo "CC: $CC"
        if [ -f "$CC" ]; then
            echo "✓ 编译器存在"
            $CC --version
        else
            echo "✗ 错误: 编译器 $CC 不存在"
            echo "检查工具链目录:"
            ls -la "$TOOLCHAIN/bin/" | grep -E "(clang|${CLANG_PREFIX})" | head -20
            exit 1
        fi
        
        # 1. 首先构建 openssl
        echo "================================================"
        echo "构建 OpenSSL 3.1.4"
        echo "================================================"
        
        if [ ! -f "openssl-3.1.4.tar.gz" ]; then
            echo "下载 OpenSSL..."
            wget -q https://www.openssl.org/source/openssl-3.1.4.tar.gz || \
            wget -q https://github.com/openssl/openssl/releases/download/openssl-3.1.4/openssl-3.1.4.tar.gz
        fi
        
        if [ ! -d "openssl-3.1.4" ]; then
            echo "解压 OpenSSL..."
            tar -xzf openssl-3.1.4.tar.gz
        fi
        
        cd openssl-3.1.4
        
        # 清理之前可能的构建
        make distclean 2>/dev/null || true
        
        # 设置环境变量
        export ANDROID_NDK_ROOT="$NDK_PATH"
        
        echo "目标架构: $TARGET"
        echo "OPENSSL_CONFIG: $OPENSSL_CONFIG"
        echo "CC: $CC"
        echo "AR: $AR"
        echo "RANLIB: $RANLIB"
        
        echo "配置 OpenSSL 为 $OPENSSL_CONFIG..."
        
        # 修复 OpenSSL 配置：使用简单的配置
        ./Configure $OPENSSL_CONFIG \
            --prefix="$DEPS_DIR/install" \
            --libdir=lib \
            no-shared \
            no-dso \
            no-ui-console \
            -D__ANDROID_API__=${ANDROID_API} \
            -static
        
        echo "编译 OpenSSL..."
        # 在 make 时传递编译器变量
        if ! make CC="$CC" AR="$AR" RANLIB="$RANLIB" -j$(nproc) 2>&1; then
            echo "OpenSSL 编译失败，尝试简化构建..."
            make distclean 2>/dev/null || true
            
            # 简化配置
            ./Configure $OPENSSL_CONFIG \
                --prefix="$DEPS_DIR/install" \
                no-shared \
                -D__ANDROID_API__=${ANDROID_API}
            
            if ! make CC="$CC" AR="$AR" RANLIB="$RANLIB" -j$(nproc); then
                echo "错误: OpenSSL 编译失败"
                exit 1
            fi
        fi
        
        echo "安装 OpenSSL..."
        make install_sw
        
        cd ..
        echo "✓ OpenSSL 构建完成"
        
        # 2. 构建 libxml2
        echo "================================================"
        echo "构建 libxml2 2.11.7"
        echo "================================================"
        
        if [ ! -f "libxml2-2.11.7.tar.xz" ]; then
            echo "下载 libxml2..."
            wget -q https://download.gnome.org/sources/libxml2/2.11/libxml2-2.11.7.tar.xz
        fi
        
        if [ ! -d "libxml2-2.11.7" ]; then
            echo "解压 libxml2..."
            tar -xJf libxml2-2.11.7.tar.xz
        fi
        
        cd libxml2-2.11.7
        
        # 清理
        make distclean 2>/dev/null || true
        rm -rf build
        mkdir -p build
        cd build
        
        echo "配置 libxml2..."
        ../configure \
            --host="$TARGET" \
            --prefix="$DEPS_DIR/install" \
            --enable-static \
            --disable-shared \
            --without-python \
            --without-lzma \
            --without-modules \
            --with-sysroot="$SYSROOT" \
            CFLAGS="-Os -fPIE -fPIC" \
            AR="$AR" \
            CC="$CC" \
            LD="$LD" \
            RANLIB="$RANLIB"
        
        echo "编译 libxml2..."
        make -j$(nproc)
        make install
        
        cd ../..
        echo "✓ libxml2 构建完成"
        
        # 3. 构建 curl
        echo "================================================"
        echo "构建 curl 8.5.0"
        echo "================================================"
        
        if [ ! -f "curl-8.5.0.tar.gz" ]; then
            echo "下载 curl..."
            wget -q https://curl.se/download/curl-8.5.0.tar.gz
        fi
        
        if [ ! -d "curl-8.5.0" ]; then
            echo "解压 curl..."
            tar -xzf curl-8.5.0.tar.gz
        fi
        
        cd curl-8.5.0
        
        # 清理
        make distclean 2>/dev/null || true
        rm -rf build
        mkdir -p build
        cd build
        
        echo "配置 curl..."
        ../configure \
            --host="$TARGET" \
            --prefix="$DEPS_DIR/install" \
            --enable-static \
            --disable-shared \
            --with-openssl="$DEPS_DIR/install" \
            --without-libssh2 \
            --without-librtmp \
            --without-libidn2 \
            --without-brotli \
            --without-zstd \
            --disable-ldap \
            --disable-ldaps \
            CFLAGS="-Os -fPIE -fPIC --with-sysroot='$SYSROOT'" \
            AR="$AR" \
            CC="$CC" \
            LD="$LD" \
            RANLIB="$RANLIB"
        
        echo "编译 curl..."
        make -j$(nproc)
        make install
        
        cd ../..
        echo "✓ curl 构建完成"
        
        # 4. 构建 sqlite
        echo "================================================"
        echo "构建 SQLite 3510200"
        echo "================================================"
        
        if [ ! -f "sqlite-autoconf-3510200.tar.gz" ]; then
            echo "下载 SQLite..."
            wget -q https://www.sqlite.org/2026/sqlite-autoconf-3510200.tar.gz
        fi
        
        if [ ! -d "sqlite-autoconf-3510200" ]; then
            echo "解压 SQLite..."
            tar -xzf sqlite-autoconf-3510200.tar.gz
        fi
        
        cd sqlite-autoconf-3510200
        
        # 清理
        make distclean 2>/dev/null || true
        rm -rf build
        mkdir -p build
        cd build
        
        echo "配置 SQLite..."
        ../configure \
            --host="$TARGET" \
            --prefix="$DEPS_DIR/install" \
            --enable-static \
            --disable-shared \
            --disable-readline \
            CFLAGS="-Os -fPIE -fPIC --with-sysroot='$SYSROOT' -DSQLITE_ENABLE_COLUMN_METADATA -DSQLITE_ENABLE_FTS3 -DSQLITE_ENABLE_FTS4 -DSQLITE_ENABLE_FTS5 -DSQLITE_ENABLE_JSON1 -DSQLITE_ENABLE_RTREE -DSQLITE_MAX_VARIABLE_NUMBER=250000" \
            AR="$AR" \
            CC="$CC" \
            LD="$LD"
        
        echo "编译 SQLite..."
        make -j$(nproc)
        make install
        
        cd ../..
        echo "✓ SQLite 构建完成"
        
        # 5. 构建 oniguruma
        echo "================================================"
        echo "构建 oniguruma 6.9.9"
        echo "================================================"
        
        if [ ! -f "onig-6.9.9.tar.gz" ]; then
            echo "下载 oniguruma..."
            wget -q https://github.com/kkos/oniguruma/releases/download/v6.9.9/onig-6.9.9.tar.gz
        fi
        
        if [ ! -d "onig-6.9.9" ]; then
            echo "解压 oniguruma..."
            tar -xzf onig-6.9.9.tar.gz
        fi
        
        cd onig-6.9.9
        
        # 清理
        make distclean 2>/dev/null || true
        rm -rf build
        mkdir -p build
        cd build
        
        echo "配置 oniguruma..."
        ../configure \
            --host="$TARGET" \
            --prefix="$DEPS_DIR/install" \
            --enable-static \
            --disable-shared \
            --with-sysroot="$SYSROOT" \
            CFLAGS="-Os -fPIE -fPIC" \
            AR="$AR" \
            CC="$CC" \
            LD="$LD" \
            RANLIB="$RANLIB"
        
        echo "编译 oniguruma..."
        make -j$(nproc)
        make install
        
        cd ../..
        echo "✓ oniguruma 构建完成"
        
        # 6. 构建 libzip
        echo "================================================"
        echo "构建 libzip 1.10.1"
        echo "================================================"
        
        if [ ! -f "libzip-1.10.1.tar.gz" ]; then
            echo "下载 libzip..."
            wget -q https://libzip.org/download/libzip-1.10.1.tar.gz
        fi
        
        if [ ! -d "libzip-1.10.1" ]; then
            echo "解压 libzip..."
            tar -xzf libzip-1.10.1.tar.gz
        fi
        
        cd libzip-1.10.1
        
        # 清理
        make distclean 2>/dev/null || true
        rm -rf build
        mkdir -p build
        cd build
        
        echo "配置 libzip..."
        ../configure \
            --host="$TARGET" \
            --prefix="$DEPS_DIR/install" \
            --enable-static \
            --disable-shared \
            --without-bzip2 \
            --without-lzma \
            --without-zstd \
            --with-sysroot="$SYSROOT" \
            CFLAGS="-Os -fPIE -fPIC" \
            AR="$AR" \
            CC="$CC" \
            LD="$LD" \
            RANLIB="$RANLIB"
        
        echo "编译 libzip..."
        make -j$(nproc)
        make install
        
        cd ../..
        echo "✓ libzip 构建完成"
        
        echo ""
        echo "================================================"
        echo "所有依赖库构建完成!"
        echo "安装目录: $DEPS_DIR/install"
        echo "================================================"
        
        # 显示构建的库文件
        echo "已构建的静态库:"
        find "$DEPS_DIR/install" -name "*.a" | xargs -I{} basename {} | sort
        
        # 设置环境变量
        echo "DEPS_DIR=$DEPS_DIR" >> $GITHUB_ENV
        echo "DEPS_INSTALL_DIR=$DEPS_DIR/install" >> $GITHUB_ENV
    
    - name: Configure PHP
      run: |
        cd $PHP_SOURCE_DIR
        
        # 清理之前的构建
        make distclean 2>/dev/null || true
        ./configure --clean 2>/dev/null || true
        
        # 配置PHP，使用编译好的依赖库
        ./buildconf --force
        
        # 添加依赖库路径
        export PKG_CONFIG_PATH="$DEPS_INSTALL_DIR/lib/pkgconfig:$PKG_CONFIG_PATH"
        export CFLAGS="$CFLAGS -I$DEPS_INSTALL_DIR/include"
        export LDFLAGS="$LDFLAGS -L$DEPS_INSTALL_DIR/lib"
        export CPPFLAGS="$CFLAGS"
        
        echo "配置 PHP..."
        ./configure \
          --host="$TARGET" \
          --target="$TARGET" \
          --prefix=/data/local/tmp/php \
          --with-sysroot="$SYSROOT" \
          --enable-embed=static \
          --enable-static \
          --disable-shared \
          --disable-all \
          --disable-cgi \
          --disable-cli \
          --without-pear \
          --enable-filter \
          --enable-hash \
          --enable-json \
          --enable-libxml \
          --enable-mbstring \
          --enable-opcache \
          --enable-phar \
          --enable-session \
          --enable-tokenizer \
          --enable-xml \
          --enable-xmlreader \
          --enable-xmlwriter \
          --with-curl="$DEPS_INSTALL_DIR" \
          --with-libedit \
          --with-openssl="$DEPS_INSTALL_DIR" \
          --with-zlib \
          --with-zip="$DEPS_INSTALL_DIR" \
          --with-mysqli=mysqlnd \
          --with-pdo-mysql=mysqlnd \
          --with-pdo-sqlite="$DEPS_INSTALL_DIR" \
          --with-sqlite3="$DEPS_INSTALL_DIR" \
          --with-iconv \
          --with-gmp \
          --with-xsl \
          --enable-gd \
          --with-freetype \
          --with-jpeg \
          --with-webp \
          --enable-bcmath \
          --enable-calendar \
          --enable-exif \
          --enable-ftp \
          --enable-pcntl \
          --enable-soap \
          --enable-sockets \
          --enable-sysvmsg \
          --enable-sysvsem \
          --enable-sysvshm \
          --with-config-file-path=/data/local/tmp/php \
          --with-config-file-scan-dir=/data/local/tmp/php/conf.d \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          AR="$AR" \
          CC="$CC" \
          CXX="$CXX" \
          LD="$LD" \
          RANLIB="$RANLIB" \
          STRIP="$STRIP"
    
    - name: Build PHP
      run: |
        cd $PHP_SOURCE_DIR
        echo "编译 PHP..."
        make -j$(nproc)
        
        echo "清理调试符号..."
        $STRIP sapi/cli/php
        
    - name: Verify binary
      run: |
        echo "验证生成的PHP二进制文件:"
        file $PHP_SOURCE_DIR/sapi/cli/php
        echo -e "\n动态库依赖:"
        $TOOLCHAIN/bin/llvm-readelf -d $PHP_SOURCE_DIR/sapi/cli/php | grep NEEDED || echo "无动态依赖（理想状态）"
        
    - name: Create release package
      run: |
        mkdir -p release/php-${{ env.PHP_VERSION }}-android-${{ matrix.arch }}
        cp $PHP_SOURCE_DIR/sapi/cli/php release/php-${{ env.PHP_VERSION }}-android-${{ matrix.arch }}/php
        
        # 创建基本的php.ini文件
        cat > release/php-${{ env.PHP_VERSION }}-android-${{ matrix.arch }}/php.ini << 'EOF'
        [PHP]
        engine = On
        short_open_tag = Off
        precision = 14
        output_buffering = 4096
        zlib.output_compression = Off
        implicit_flush = Off
        unserialize_callback_func =
        serialize_precision = -1
        
        ; 禁用危险函数
        disable_functions = exec,passthru,shell_exec,system,proc_open,popen
        
        [Date]
        date.timezone = Asia/Shanghai
        
        [opcache]
        opcache.enable=1
        opcache.memory_consumption=128
        opcache.interned_strings_buffer=8
        opcache.max_accelerated_files=10000
        opcache.revalidate_freq=2
        
        ; 扩展目录
        extension_dir = "/data/local/tmp/php/ext"
        EOF
        
        # 创建启动脚本
        cat > release/php-${{ env.PHP_VERSION }}-android-${{ matrix.arch }}/start.sh << 'EOF'
        #!/system/bin/sh
        DIR="$(cd "$(dirname "$0")" && pwd)"
        export PHP_INI_SCAN_DIR="$DIR/conf.d"
        $DIR/php -c "$DIR/php.ini" "$@"
        EOF
        
        chmod +x release/php-${{ env.PHP_VERSION }}-android-${{ matrix.arch }}/start.sh
        
        # 创建README文件
        cat > release/php-${{ env.PHP_VERSION }}-android-${{ matrix.arch }}/README.md << 'EOF'
        # PHP for Android
        
        这是一个为Android编译的静态PHP二进制文件。
        
        ## 使用方法
        
        1. 将文件复制到Android设备
        2. 在终端中运行: `./start.sh -v`
        3. 检查PHP版本信息
        
        ## 包含的扩展
        
        - 核心扩展: filter, hash, json, libxml, mbstring, opcache, phar, session, tokenizer, xml
        - 数据库: mysqli, pdo_mysql, pdo_sqlite, sqlite3
        - 网络: curl, ftp, soap, sockets
        - 图像: gd (支持JPEG, PNG, WebP, FreeType)
        - 其他: bcmath, calendar, exif, gmp, iconv, pcntl, xsl, zip
        
        ## 注意事项
        
        - 这是一个静态编译的二进制文件，不依赖系统库
        - 禁用了一些危险函数
        - 默认时区设置为Asia/Shanghai
        EOF
        
        # 压缩发布包
        cd release
        tar -czf php-${{ env.PHP_VERSION }}-android-${{ matrix.arch }}.tar.gz php-${{ env.PHP_VERSION }}-android-${{ matrix.arch }}
        
        # 显示文件大小
        echo "生成的发布包:"
        ls -lh *.tar.gz
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: php-android-${{ matrix.arch }}
        path: |
          release/php-${{ env.PHP_VERSION }}-android-${{ matrix.arch }}.tar.gz
        retention-days: 7
    
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/php-${{ env.PHP_VERSION }}-android-arm64.tar.gz
          release/php-${{ env.PHP_VERSION }}-android-arm.tar.gz
          release/php-${{ env.PHP_VERSION }}-android-x86_64.tar.gz
          release/php-${{ env.PHP_VERSION }}-android-x86.tar.gz
        generate_release_notes: true
