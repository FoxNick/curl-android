name: Build PHP for Android

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      php_version:
        description: 'PHP version to build'
        required: true
        default: '8.3.0'

env:
  ANDROID_NDK_VERSION: 'r26b'
  ANDROID_API: 21
  PHP_VERSION: ${{ github.event.inputs.php_version || '8.3.0' }}

jobs:
  build:
    runs-on: ubuntu-22.04
    
    strategy:
      matrix:
        arch: [arm64, arm, x86_64, x86]
        include:
          - arch: arm64
            target: aarch64-linux-android
            clang_target: aarch64-none-linux-android21
          - arch: arm
            target: armv7a-linux-androideabi
            clang_target: armv7a-linux-androideabi21
          - arch: x86_64
            target: x86_64-linux-android
            clang_target: x86_64-linux-android21
          - arch: x86
            target: i686-linux-android
            clang_target: i686-linux-android21
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Android NDK
      run: |
        mkdir -p /tmp/android-ndk
        cd /tmp/android-ndk
        wget -q https://dl.google.com/android/repository/android-ndk-${{ env.ANDROID_NDK_VERSION }}-linux.zip
        unzip -q android-ndk-${{ env.ANDROID_NDK_VERSION }}-linux.zip
        echo "NDK_PATH=/tmp/android-ndk/android-ndk-${{ env.ANDROID_NDK_VERSION }}" >> $GITHUB_ENV
        echo "$(pwd)/android-ndk-${{ env.ANDROID_NDK_VERSION }}/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          autoconf \
          automake \
          libtool \
          pkg-config \
          bison \
          re2c \
          libxml2-dev \
          libssl-dev \
          libcurl4-openssl-dev \
          libsqlite3-dev \
          libonig-dev \
          libzip-dev \
          zlib1g-dev \
          libpng-dev \
          libjpeg-dev \
          libwebp-dev \
          libfreetype6-dev \
          libgmp-dev \
          libedit-dev \
          libxslt1-dev
    
    - name: Download PHP source
      run: |
        wget -q https://www.php.net/distributions/php-${{ env.PHP_VERSION }}.tar.gz
        tar -xzf php-${{ env.PHP_VERSION }}.tar.gz
        echo "PHP_SOURCE_DIR=$(pwd)/php-${{ env.PHP_VERSION }}" >> $GITHUB_ENV
    
    - name: Setup cross-compilation environment
      run: |
        export TOOLCHAIN="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64"
        export AR="$TOOLCHAIN/bin/llvm-ar"
        export CC="$TOOLCHAIN/bin/${{ matrix.clang_target }}-clang"
        export CXX="$TOOLCHAIN/bin/${{ matrix.clang_target }}-clang++"
        export LD="$TOOLCHAIN/bin/ld"
        export RANLIB="$TOOLCHAIN/bin/llvm-ranlib"
        export STRIP="$TOOLCHAIN/bin/llvm-strip"
        
        export CFLAGS="-Os -fPIE -fPIC -D__ANDROID_API__=${{ env.ANDROID_API }}"
        export LDFLAGS="-pie"
        
        echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV
        echo "TARGET=${{ matrix.target }}" >> $GITHUB_ENV
        echo "CLANG_TARGET=${{ matrix.clang_target }}" >> $GITHUB_ENV
        echo "SYSROOT=$TOOLCHAIN/sysroot" >> $GITHUB_ENV
        echo "CFLAGS=$CFLAGS" >> $GITHUB_ENV
        echo "LDFLAGS=$LDFLAGS" >> $GITHUB_ENV
        echo "AR=$AR" >> $GITHUB_ENV
        echo "CC=$CC" >> $GITHUB_ENV
        echo "CXX=$CXX" >> $GITHUB_ENV
        echo "LD=$LD" >> $GITHUB_ENV
        echo "RANLIB=$RANLIB" >> $GITHUB_ENV
        echo "STRIP=$STRIP" >> $GITHUB_ENV
    
    - name: Build dependencies (static libraries)
      run: |
        # 创建构建依赖脚本
        cat > build-deps.sh << 'EOF'
        #!/bin/bash
        set -e

        # 设置变量
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        DEPS_DIR="$SCRIPT_DIR/build_deps"
        mkdir -p "$DEPS_DIR"
        cd "$DEPS_DIR"

        # 设置编译器
        export TOOLCHAIN="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64"
        export AR="$TOOLCHAIN/bin/llvm-ar"
        export CC="$TOOLCHAIN/bin/${CLANG_TARGET}-clang"
        export CXX="$TOOLCHAIN/bin/${CLANG_TARGET}-clang++"
        export LD="$TOOLCHAIN/bin/ld"
        export RANLIB="$TOOLCHAIN/bin/llvm-ranlib"
        export STRIP="$TOOLCHAIN/bin/llvm-strip"
        export SYSROOT="$TOOLCHAIN/sysroot"

        # 通用编译函数
        build_lib() {
            local name=$1
            local version=$2
            local url=$3
            local extra_flags=$4
            
            echo "Building $name $version..."
            
            if [ ! -f "${name}-${version}.tar.gz" ]; then
                wget -q "$url"
            fi
            
            tar -xzf "${name}-${version}.tar.gz"
            cd "${name}-${version}"
            
            mkdir -p build
            cd build
            
            ../configure \
                --host="${TARGET}" \
                --prefix="$DEPS_DIR/install" \
                --enable-static \
                --disable-shared \
                --disable-dependency-tracking \
                --with-sysroot="$SYSROOT" \
                $extra_flags \
                CFLAGS="-Os -fPIE -fPIC" \
                CXXFLAGS="-Os -fPIE -fPIC" \
                AR="$AR" \
                CC="$CC" \
                CXX="$CXX" \
                LD="$LD" \
                RANLIB="$RANLIB"
            
            make -j$(nproc)
            make install
            cd ../..
        }

        # 编译 libxml2
        build_lib "libxml2" "2.11.7" \
            "https://download.gnome.org/sources/libxml2/2.11/libxml2-2.11.7.tar.xz" \
            "--without-python --without-lzma"

        # 编译 openssl
        echo "Building OpenSSL..."
        OPENSSL_VERSION="3.1.4"
        if [ ! -f "openssl-${OPENSSL_VERSION}.tar.gz" ]; then
            wget -q "https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz"
        fi
        tar -xzf "openssl-${OPENSSL_VERSION}.tar.gz"
        cd "openssl-${OPENSSL_VERSION}"
        ./Configure \
            linux-generic32 \
            --prefix="$DEPS_DIR/install" \
            --libdir=lib \
            no-shared \
            no-dso \
            no-ui-console \
            -D__ANDROID_API__=${ANDROID_API} \
            --cross-compile-prefix="${TARGET}-"
        make -j$(nproc)
        make install_sw
        cd ..

        # 编译 curl
        build_lib "curl" "8.5.0" \
            "https://curl.se/download/curl-8.5.0.tar.gz" \
            "--with-openssl=$DEPS_DIR/install --without-ssl --without-libssh2 --without-librtmp --without-libidn2 --without-brotli --without-zstd"

        # 编译 sqlite
        SQLITE_VERSION="3440000"
        echo "Building SQLite..."
        if [ ! -f "sqlite-autoconf-${SQLITE_VERSION}.tar.gz" ]; then
            wget -q "https://www.sqlite.org/2024/sqlite-autoconf-${SQLITE_VERSION}.tar.gz"
        fi
        tar -xzf "sqlite-autoconf-${SQLITE_VERSION}.tar.gz"
        cd "sqlite-autoconf-${SQLITE_VERSION}"
        mkdir -p build
        cd build
        ../configure \
            --host="${TARGET}" \
            --prefix="$DEPS_DIR/install" \
            --enable-static \
            --disable-shared \
            --disable-readline \
            CFLAGS="-Os -fPIE -fPIC -DSQLITE_ENABLE_COLUMN_METADATA -DSQLITE_ENABLE_FTS3 -DSQLITE_ENABLE_FTS4 -DSQLITE_ENABLE_FTS5 -DSQLITE_ENABLE_JSON1 -DSQLITE_ENABLE_RTREE -DSQLITE_MAX_VARIABLE_NUMBER=250000" \
            AR="$AR" \
            CC="$CC" \
            LD="$LD"
        make -j$(nproc)
        make install
        cd ../..

        # 编译 oniguruma (mbstring依赖)
        build_lib "onig" "6.9.9" \
            "https://github.com/kkos/oniguruma/releases/download/v6.9.9/onig-6.9.9.tar.gz" \
            ""

        # 编译 libzip
        build_lib "libzip" "1.10.1" \
            "https://libzip.org/download/libzip-1.10.1.tar.gz" \
            "--without-bzip2 --without-lzma --without-zstd"

        echo "Dependencies built successfully!"
        EOF

        # 赋予执行权限并运行
        chmod +x build-deps.sh
        ./build-deps.sh
        
        # 设置环境变量供后续步骤使用
        echo "DEPS_DIR=$(pwd)/build_deps" >> $GITHUB_ENV
        echo "DEPS_INSTALL_DIR=$(pwd)/build_deps/install" >> $GITHUB_ENV
    
    - name: Configure PHP
      run: |
        cd $PHP_SOURCE_DIR
        
        # 清理之前的构建
        make distclean 2>/dev/null || true
        ./configure --clean 2>/dev/null || true
        
        # 配置PHP，使用编译好的依赖库
        ./buildconf --force
        
        ./configure \
          --host=${{ matrix.target }} \
          --target=${{ matrix.target }} \
          --prefix=/data/local/tmp/php \
          --with-sysroot=$SYSROOT \
          --enable-embed=static \
          --enable-static \
          --disable-shared \
          --disable-all \
          --disable-cgi \
          --disable-cli \
          --without-pear \
          --enable-filter \
          --enable-hash \
          --enable-json \
          --enable-libxml \
          --enable-mbstring \
          --enable-opcache \
          --enable-phar \
          --enable-session \
          --enable-tokenizer \
          --enable-xml \
          --enable-xmlreader \
          --enable-xmlwriter \
          --with-curl=$DEPS_INSTALL_DIR \
          --with-libedit \
          --with-openssl=$DEPS_INSTALL_DIR \
          --with-zlib \
          --with-zip=$DEPS_INSTALL_DIR \
          --with-mysqli=mysqlnd \
          --with-pdo-mysql=mysqlnd \
          --with-pdo-sqlite=$DEPS_INSTALL_DIR \
          --with-sqlite3=$DEPS_INSTALL_DIR \
          --with-iconv \
          --with-gmp \
          --with-xsl \
          --enable-gd \
          --with-freetype \
          --with-jpeg \
          --with-webp \
          --enable-bcmath \
          --enable-calendar \
          --enable-exif \
          --enable-ftp \
          --enable-pcntl \
          --enable-soap \
          --enable-sockets \
          --enable-sysvmsg \
          --enable-sysvsem \
          --enable-sysvshm \
          --with-config-file-path=/data/local/tmp/php \
          --with-config-file-scan-dir=/data/local/tmp/php/conf.d \
          CFLAGS="$CFLAGS -I$DEPS_INSTALL_DIR/include" \
          LDFLAGS="$LDFLAGS -L$DEPS_INSTALL_DIR/lib" \
          AR="$AR" \
          CC="$CC" \
          CXX="$CXX" \
          LD="$LD" \
          RANLIB="$RANLIB" \
          STRIP="$STRIP"
    
    - name: Build PHP
      run: |
        cd $PHP_SOURCE_DIR
        make -j$(nproc)
        $STRIP sapi/cli/php
        
    - name: Create release package
      run: |
        mkdir -p release/php-${{ env.PHP_VERSION }}-android-${{ matrix.arch }}
        cp $PHP_SOURCE_DIR/sapi/cli/php release/php-${{ env.PHP_VERSION }}-android-${{ matrix.arch }}/php
        
        # 创建基本的php.ini文件
        cat > release/php-${{ env.PHP_VERSION }}-android-${{ matrix.arch }}/php.ini << 'EOF'
        [PHP]
        engine = On
        short_open_tag = Off
        precision = 14
        output_buffering = 4096
        zlib.output_compression = Off
        implicit_flush = Off
        unserialize_callback_func =
        serialize_precision = -1
        
        ; 禁用危险函数
        disable_functions = exec,passthru,shell_exec,system,proc_open,popen
        
        [Date]
        date.timezone = Asia/Shanghai
        
        [opcache]
        opcache.enable=1
        opcache.memory_consumption=128
        opcache.interned_strings_buffer=8
        opcache.max_accelerated_files=10000
        opcache.revalidate_freq=2
        EOF
        
        # 创建启动脚本
        cat > release/php-${{ env.PHP_VERSION }}-android-${{ matrix.arch }}/start.sh << 'EOF'
        #!/system/bin/sh
        DIR="$(cd "$(dirname "$0")" && pwd)"
        export PHP_INI_SCAN_DIR="$DIR/conf.d"
        $DIR/php -c "$DIR/php.ini" "$@"
        EOF
        
        chmod +x release/php-${{ env.PHP_VERSION }}-android-${{ matrix.arch }}/start.sh
        
        # 压缩发布包
        cd release
        tar -czf php-${{ env.PHP_VERSION }}-android-${{ matrix.arch }}.tar.gz php-${{ env.PHP_VERSION }}-android-${{ matrix.arch }}
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: php-android-${{ matrix.arch }}
        path: |
          release/php-${{ env.PHP_VERSION }}-android-${{ matrix.arch }}.tar.gz
          release/php-${{ env.PHP_VERSION }}-android-${{ matrix.arch }}/php
    
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/php-${{ env.PHP_VERSION }}-android-arm64.tar.gz
          release/php-${{ env.PHP_VERSION }}-android-arm.tar.gz
          release/php-${{ env.PHP_VERSION }}-android-x86_64.tar.gz
          release/php-${{ env.PHP_VERSION }}-android-x86.tar.gz
        generate_release_notes: true
